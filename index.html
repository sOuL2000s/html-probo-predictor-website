<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Probo Predictor</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Plotly.js CDN for charting -->
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Favicon links (ensure these files are in your root directory) -->
    <!-- You might want to create and include proper favicons if deploying -->
    <!-- <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"> -->
    <!-- <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"> -->
    <!-- <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"> -->
    <!-- <link rel="manifest" href="/site.webmanifest"> -->
    <!-- <link rel="shortcut icon" href="/favicon.ico"> -->

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Black background */
            color: #DAA520; /* Goldenrod text for general content */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            min-height: 100vh;
            overflow-y: auto; /* Allow scrolling */
        }
        .container {
            background-color: #1a1a1a; /* Slightly lighter black for container */
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 800px; /* Max width for desktop */
            margin: 1rem; /* Margin for mobile and desktop */
            box-sizing: border-box;
        }
        h1, h2, h3, h4 {
            color: #FFD700; /* Gold for headings */
        }
        input[type="number"], input[type="time"], button, select, textarea {
            background-color: #222222; /* Darker grey for inputs */
            border: 1px solid #444444; /* Darker grey border */
            color: #FFD700; /* Gold text */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        input[type="number"]:focus, input[type="time"]:focus, button:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #FFD700; /* Gold border on focus */
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3); /* Gold shadow on focus */
        }
        button {
            cursor: pointer;
            font-weight: 600;
            background-color: #FFD700; /* Gold button */
            border-color: #FFD700;
            color: #000000; /* Black text on gold button */
            display: flex; /* Enable flex for icon and text alignment */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Space between icon and text */
        }
        button:hover {
            background-color: #DAA520; /* Darker gold on hover */
            border-color: #DAA520;
        }
        .metric-value {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* font-bold */
            color: #FFD700; /* Gold */
        }
        .expander-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem; /* Added horizontal padding */
            font-weight: 600;
            color: #DAA520; /* Goldenrod */
            border-bottom: 1px solid #444444;
            transition: background-color 0.2s ease-in-out, border-radius 0.2s ease-in-out;
        }
        .expander-header:hover {
            background-color: #2a2a2a; /* Slightly darker grey on hover */
            border-radius: 0.5rem; /* Apply border-radius on hover */
        }
        .expander-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding: 0 1rem; /* Horizontal padding always, vertical only when expanded */
        }
        .expander-content.expanded {
            max-height: 9999px; /* Large enough value */
            padding: 1rem;
        }
        .arrow {
            transition: transform 0.3s ease-out;
        }
        .arrow.expanded {
            transform: rotate(90deg);
        }
        .plotly-graph-div {
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: #222222; /* Darker background for chart area */
        }
        .plotly .modebar {
            background-color: #222222 !important;
            border-radius: 0.5rem;
            padding: 0.25rem;
        }
        .plotly .modebar-btn {
            color: #FFD700 !important;
        }
        .plotly .modebar-btn:hover {
            background-color: #444444 !important;
        }
        /* Custom message boxes for gold/black theme */
        .success-message {
            background-color: #2a3620; /* Darker green */
            color: #d4edda; /* Lighter green */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .warning-message {
            background-color: #4d3a20; /* Darker orange */
            color: #fce8d4; /* Lighter orange */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .info-message {
            background-color: #20364d; /* Darker blue */
            color: #d4e8fc; /* Lighter blue */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .error-message {
            background-color: #4d2020; /* Darker red */
            color: #fcd4d4; /* Lighter red */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #FFD700; /* Gold */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Text colors for YES/NO in confidence advisor */
        .text-green-400 { color: #82E0AA; } /* Adjusted green for better contrast */
        .text-red-400 { color: #F1948A; } /* Adjusted red for better contrast */
        .check-icon { color: #28B463; } /* Stronger green for checkmark */
        .cross-icon { color: #E74C3C; } /* Stronger red for crossmark */

        /* Chatbot specific styles */
        #chat-window {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #444;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #222222;
        }
        .chat-message {
            margin-bottom: 0.75rem;
            display: flex;
        }
        .chat-message.user {
            justify-content: flex-end;
        }
        .chat-message.ai {
            justify-content: flex-start;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            line-height: 1.4;
        }
        .chat-bubble.user {
            background-color: #FFD700; /* Gold bubble for user */
            color: #000000; /* Black text */
            border-bottom-right-radius: 0;
        }
        .chat-bubble.ai {
            background-color: #333333; /* Darker grey bubble for AI */
            color: #FFD700; /* Gold text */
            border-bottom-left-radius: 0;
        }
        .chat-file-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            display: block;
        }
        .file-upload-list {
            list-style: none;
            padding: 0;
            margin-top: 0.5rem;
        }
        .file-upload-list li {
            background-color: #333;
            padding: 0.4rem 0.6rem;
            border-radius: 0.3rem;
            margin-bottom: 0.3rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .file-upload-list li .remove-file {
            cursor: pointer;
            color: #F1948A;
            margin-left: 0.5rem;
        }

        /* Floating Chatbot styles */
        #floating-chat-window-content {
            width: 384px; /* Default Tailwind w-96 */
            max-height: 80vh; /* Max height for the chatbot window */
            max-width: calc(100vw - 2rem); /* Max width for mobile screens */
            transition: all 0.3s ease-in-out;
        }
        #chat-toggle-btn {
            background-color: #FFD700;
            color: #000000;
            padding: 1rem;
            border-radius: 9999px; /* Tailwind 'rounded-full' */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem; /* Tailwind 'text-2xl' */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin-bottom: 0.5rem; /* Space between button and chat window */
            min-width: 56px; /* Ensure button is round */
            min-height: 56px; /* Ensure button is round */
        }
        #chat-toggle-btn:hover {
            background-color: #DAA520;
        }
        /* Mobile adjustments for floating chatbot */
        @media (max-width: 768px) {
            #floating-chat-window-content {
                width: calc(100vw - 2rem); /* Full width on smaller screens, with margin */
                right: 1rem;
                left: 1rem;
            }
            #floating-chatbot-container {
                right: 0.5rem;
                left: 0.5rem;
                bottom: 0.5rem;
                align-items: center; /* Center the button and window on mobile */
            }
        }
    </style>
</head>
<body class="antialiased">
    <div class="container">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6">
            <i class="fas fa-chart-line text-gold-500 mr-3"></i> Crypto Probo Predictor
        </h1>

        <div class="text-center text-gray-400 mb-6">
            <p>Unveiling the future of crypto with advanced analytics. Input your Probo deal details to receive an AI-powered prediction and confidence assessment.</p>
        </div>

        <!-- Currency Selector -->
        <div class="bg-gray-900 p-4 rounded-lg shadow-md mb-6 flex flex-col md:flex-row justify-between items-center">
            <span class="text-xl font-medium text-gray-400 mb-2 md:mb-0">
                <i class="fas fa-coins text-gold-300 mr-2"></i> Select Cryptocurrency:
            </span>
            <div class="flex space-x-4">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" class="form-radio text-yellow-500 h-5 w-5" name="currency" value="BTC" checked>
                    <span class="ml-2 text-gold-300"><i class="fab fa-btc mr-1"></i> Bitcoin (BTC)</span>
                </label>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" class="form-radio text-yellow-500 h-5 w-5" name="currency" value="ETH">
                    <span class="ml-2 text-gold-300"><i class="fab fa-ethereum mr-1"></i> Ethereum (ETH)</span>
                </label>
            </div>
        </div>

        <!-- Current Price Metric -->
        <div class="bg-gray-900 p-4 rounded-lg shadow-md mb-6 flex justify-between items-center">
            <span class="text-xl font-medium text-gray-400">
                <i class="fas fa-sack-dollar text-gold-300 mr-2"></i> Current Price (<span id="current-currency-symbol">BTC</span>)
            </span>
            <span id="current-price-display" class="metric-value">$0.00</span>
            <div id="loading-spinner" class="loader hidden"></div>
        </div>

        <hr class="border-gray-800 my-6">

        <!-- Prediction Form -->
        <h2 class="text-2xl font-semibold mb-4 text-gold-100">
            <i class="fas fa-crystal-ball text-gold-500 mr-2"></i> Predict Probo Outcome
        </h2>
        <form id="prediction-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="target-price" class="block text-sm font-medium text-gray-400 mb-1">Target Price (USDT)</label>
                    <input type="number" id="target-price" value="65000" class="w-full rounded-lg px-4 py-2" step="any">
                </div>
                <div>
                    <label for="target-time" class="block text-sm font-medium text-gray-400 mb-1">Target Time (HH:MM in IST)</label>
                    <input type="time" id="target-time" value="23:00" class="w-full rounded-lg px-4 py-2">
                    <p class="text-xs text-gray-500 mt-1">Current IST: <span id="current-ist-time"></span></p>
                </div>
            </div>
            <button type="submit" class="w-full py-2 rounded-lg text-black font-semibold">
                Get Recommendation <div id="prediction-spinner" class="loader hidden"></div>
            </button>
        </form>

        <div id="prediction-results" class="mt-6 space-y-4">
            <!-- Prediction Summary -->
            <div id="prediction-summary-expander" class="expander-header rounded-lg bg-gray-900">
                <span class="text-lg text-gold-100">
                    <i class="fas fa-chart-pie text-gold-300 mr-2"></i> Prophet Prediction Summary
                </span>
                <svg class="arrow w-5 h-5 text-gold-300" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
            </div>
            <div id="prediction-summary-content" class="expander-content bg-gray-900 rounded-lg">
                <div class="p-4 space-y-2">
                    <p class="text-gold-300"><strong class="text-gold-100">Current Price:</strong> <span id="summary-current-price">$0.00</span></p>
                    <p class="text-gold-300"><strong class="text-gold-100">Avg Δ/hr:</strong> <span id="summary-avg-delta">$0.00</span></p>
                    <p class="text-gold-300"><strong class="text-gold-100">Time Left:</strong> <span id="summary-time-left">0 hr(s)</span></p>
                    <p class="text-gold-300"><strong class="text-gold-100">Projected Price:</strong> <span id="summary-projected-price">$0.00</span></p>
                    <p class="text-gold-300"><strong class="text-gold-100">Sentiment Score:</strong> <span id="summary-sentiment-score">0.00</span></p>
                    <p class="text-gold-300"><strong class="text-gold-100">Target Time (IST):</strong> <span id="summary-target-time">HH:MM</span></p>
                </div>
            </div>

            <!-- Recommended Vote (Prophet) -->
            <div id="recommended-vote-message" class="hidden text-center text-xl font-bold py-3 px-4 rounded-lg"></div>

            <!-- NEW: Gemini AI Recommended Vote -->
            <div id="gemini-ai-vote-expander" class="expander-header rounded-lg bg-gray-900 mt-4">
                <span class="text-lg text-gold-100">
                    <i class="fas fa-robot text-gold-300 mr-2"></i> Gemini AI Recommendation
                </span>
                <svg class="arrow w-5 h-5 text-gold-300" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
            </div>
            <div id="gemini-ai-vote-content" class="expander-content bg-gray-900 rounded-lg">
                <div class="p-4 space-y-2">
                    <p class="text-gold-300 text-lg"><strong class="text-gold-100">Gemini AI Vote:</strong> <span id="gemini-ai-vote" class="font-bold">N/A</span></p>
                    <p class="text-gold-300"><strong class="text-gold-100">Reasoning:</strong> <span id="gemini-ai-reasoning" class="block whitespace-pre-wrap">N/A</span></p>
                    <div id="gemini-vote-spinner" class="loader hidden mx-auto"></div>
                </div>
            </div>

            <!-- Prediction Confidence Advisor -->
            <hr class="border-gray-800 my-6">
            <h3 class="text-xl font-semibold text-gold-100">
                <i class="fas fa-lightbulb text-gold-500 mr-2"></i> Prediction Confidence Advisor
            </h3>

            <div id="trust-signals-expander" class="expander-header rounded-lg bg-gray-900">
                <span class="text-lg text-gold-100">
                    <i class="fas fa-shield-alt text-green-400 mr-2"></i> Trust Signals
                </span>
                <svg class="arrow w-5 h-5 text-gold-300" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
            </div>
            <div id="trust-signals-content" class="expander-content bg-gray-900 rounded-lg">
                <ul class="list-none text-gold-300 space-y-2 p-4">
                    <li><span id="trust-time-icon"></span> Time to expiry is &lt; 2 hours: <span id="trust-time"></span></li>
                    <li><span id="trust-trend-icon"></span> <span id="trust-currency-name">BTC</span> is trending cleanly (up or down): <span id="trust-trend"></span></li>
                    <li><span id="trust-sentiment-icon"></span> Sentiment score is strongly positive/negative (&gt;0.2): <span id="trust-sentiment"></span></li>
                    <li><span id="trust-rsi-icon"></span> RSI is not extreme (30-70): <span id="trust-rsi"></span></li>
                    <li><span id="trust-news-icon"></span> No major news expected (Sentiment not conflicting): <span id="trust-news"></span></li>
                    <li><span id="trust-stable-candles-icon"></span> Candle bodies are stable (not huge wicks): <span id="trust-stable-candles"></span></li>
                    <li><span id="trust-macd-bullish-icon"></span> MACD shows bullish crossover: <span id="trust-macd-bullish"></span></li>
                    <li><span id="trust-stoch-oversold-icon"></span> Stochastic is oversold (potential rebound): <span id="trust-stoch-oversold"></span></li>
                    <li><span id="trust-bb-lower-icon"></span> Price near lower Bollinger Band (potential support): <span id="trust-bb-lower"></span></li>
                    <li><span id="trust-no-massive-move-icon"></span> No massive move recently: <span id="trust-no-massive-move"></span></li>
                    <li><span id="trust-bb-stable-icon"></span> Bollinger Bands are stable (not squeezing/expanding): <span id="trust-bb-stable"></span></li>
                    <li><span id="trust-no-volume-spike-icon"></span> No recent volume spike: <span id="trust-no-volume-spike"></span></li>
                </ul>
            </div>

            <div id="caution-flags-expander" class="expander-header rounded-lg bg-gray-900">
                <span class="text-lg text-gold-100">
                    <i class="fas fa-exclamation-triangle text-red-400 mr-2"></i> Caution Flags
                </span>
                <svg class="arrow w-5 h-5 text-gold-300" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
            </div>
            <div id="caution-flags-content" class="expander-content bg-gray-900 rounded-lg">
                <ul class="list-none text-gold-300 space-y-2 p-4">
                    <li><span id="caution-time-icon"></span> Target time is &gt; 3 hours away: <span id="caution-time"></span></li>
                    <li><span id="caution-massive-move-icon"></span> <span id="caution-currency-name">BTC</span> just made a massive move: <span id="caution-massive-move"></span></li>
                    <li><span id="caution-rsi-icon"></span> RSI is &gt; 70 or &lt; 30 (extreme): <span id="caution-rsi"></span></li>
                    <li><span id="caution-sentiment-icon"></span> Sentiment is conflicting (score ≈ 0): <span id="caution-sentiment"></span></li>
                    <li><span id="caution-big-news-icon"></span> Market Volatility due to News/Events (sentiment conflicting OR volume spike): <span id="caution-big-news"></span></li>
                    <li><span id="caution-volatile-candles-icon"></span> Candle volatility is high (huge wicks): <span id="caution-volatile-candles"></span></li>
                    <li><span id="caution-macd-bearish-icon"></span> MACD shows bearish crossover: <span id="caution-macd-bearish"></span></li>
                    <li><span id="caution-stoch-overbought-icon"></span> Stochastic is overbought (potential reversal): <span id="caution-stoch-overbought"></span></li>
                    <li><span id="caution-bb-upper-contracting-icon"></span> Price near upper Bollinger Band or BB contracting: <span id="caution-bb-upper-contracting"></span></li>
                    <li><span id="caution-bb-volatile-icon"></span> Bollinger Bands are volatile (squeezing/expanding): <span id="caution-bb-volatile"></span></li>
                    <li><span id="caution-volume-spike-icon"></span> Recent volume spike: <span id="caution-volume-spike"></span></li>
                </ul>
            </div>

            <hr class="border-gray-800 my-6">
            <p class="text-gold-300 text-lg"><strong class="text-gold-100">Total Trust Signals Met:</strong> <span id="total-trust-signals" class="text-green-400 font-bold">0</span></p>
            <p class="text-gold-300 text-lg"><strong class="text-gold-100">Total Caution Flags Present:</strong> <span id="total-caution-flags" class="text-red-400 font-bold">0</span></p>
            <div id="pro-tip-message" class="mt-4"></div>
        </div>

        <hr class="border-gray-800 my-6">

        <!-- Technical Indicators -->
        <div id="technical-indicators-expander" class="expander-header rounded-lg bg-gray-900">
            <span class="text-lg text-gold-100">
                <i class="fas fa-flask text-gold-300 mr-2"></i> Technical Indicators
            </span>
            <svg class="arrow w-5 h-5 text-gold-300" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
        </div>
        <div id="technical-indicators-content" class="expander-content bg-gray-900 rounded-lg">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center p-4">
                <div class="p-3 bg-gray-800 rounded-lg">
                    <div class="text-sm text-gray-400">RSI</div>
                    <div id="metric-rsi" class="text-xl font-bold text-gold-300">0.00</div>
                </div>
                <div class="p-3 bg-gray-800 rounded-lg">
                    <div class="text-sm text-gray-400">EMA 20</div>
                    <div id="metric-ema20" class="text-xl font-bold text-gold-300">0.00</div>
                </div>
                <div class="p-3 bg-gray-800 rounded-lg">
                    <div class="text-sm text-gray-400">EMA 50</div>
                    <div id="metric-ema50" class="text-xl font-bold text-gold-300">0.00</div>
                </div>
                <div class="p-3 bg-gray-800 rounded-lg">
                    <div class="text-sm text-gray-400">MACD</div>
                    <div id="metric-macd" class="text-xl font-bold text-gold-300">0.00</div>
                </div>
                <div class="p-3 bg-gray-800 rounded-lg">
                    <div class="text-sm text-gray-400">Stoch %K</div>
                    <div id="metric-stochk" class="text-xl font-bold text-gold-300">0.00</div>
                </div>
                <div class="p-3 bg-gray-800 rounded-lg">
                    <div class="text-sm text-gray-400">Stoch %D</div>
                    <div id="metric-stochd" class="text-xl font-bold text-gold-300">0.00</div>
                </div>
                <div class="p-3 bg-gray-800 rounded-lg col-span-1 md:col-span-3">
                    <div class="text-sm text-gray-400">Bollinger Bands (Upper/Mid/Lower)</div>
                    <div id="metric-bb" class="text-xl font-bold text-gold-300">0.00 / 0.00 / 0.00</div>
                </div>
            </div>
            <div class="mt-4 text-gold-300 p-4 pt-0 space-y-1">
                <p><strong class="text-gold-100">Trend:</strong> <span id="market-trend"></span></p>
                <p><strong class="text-gold-100">RSI Zone:</strong> <span id="market-rsi-zone"></span></p>
                <p><strong class="text-gold-100">Stochastic Zone:</strong> <span id="market-stoch-zone"></span></p>
                <p><strong class="text-gold-100">Bollinger Band Width:</strong> <span id="metric-bb-width"></span></p>
            </div>
        </div>

        <hr class="border-gray-800 my-6">

        <!-- Chart -->
        <!-- CHART EXPANDER IS NOW OPEN BY DEFAULT -->
        <div id="chart-expander" class="expander-header rounded-lg bg-gray-900 expanded">
            <span class="text-lg text-gold-100">
                <i class="fas fa-chart-area text-gold-300 mr-2"></i> View Chart
            </span>
            <svg class="arrow w-5 h-5 text-gold-300 expanded" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
        </div>
        <div id="chart-content" class="expander-content bg-gray-900 rounded-lg expanded">
            <div id="candlestick-chart" class="w-full h-[600px] p-4"></div>
        </div>

        <hr class="border-gray-800 my-6">

        <!-- NEW: Gemini AI Chatbot (Original static section - will be hidden by JS and moved) -->
        <div id="static-ai-chatbot-section" style="display: none;">
            <div id="ai-chatbot-expander" class="expander-header rounded-lg bg-gray-900 mt-4">
                <span class="text-lg text-gold-100">
                    <i class="fas fa-comments text-gold-300 mr-2"></i> AI Chatbot
                </span>
                <svg class="arrow w-5 h-5 text-gold-300" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
            </div>
            <div id="ai-chatbot-content" class="expander-content bg-gray-900 rounded-lg">
                <div id="chat-window" class="mb-4">
                    <div class="chat-message ai">
                        <div class="chat-bubble ai">Hello! I'm your Crypto Probo AI assistant. I can help analyze market data, discuss predictions, or analyze files you upload. What's on your mind?</div>
                    </div>
                </div>
                <div class="file-upload-list" id="uploaded-files-preview"></div>
                <div class="flex flex-col space-y-2">
                    <input type="file" id="chat-file-input" multiple accept="image/*, text/*, .pdf, .csv, .docx, .xlsx" class="w-full text-gold-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-gold-300 hover:file:bg-gray-600"/>
                    <textarea id="chat-input" class="w-full rounded-lg px-4 py-2" rows="3" placeholder="Ask me about crypto, market conditions, or upload a file for analysis..."></textarea>
                    <button id="send-chat-btn" class="w-full py-2 rounded-lg text-black font-semibold">
                        Send Message <div id="chat-spinner" class="loader hidden"></div>
                    </button>
                </div>
                <div id="chat-error-message" class="error-message hidden"></div>
            </div>
        </div>

        <hr class="border-gray-800 my-6">

        <!-- Overlay Feature Explanation -->
        <div class="warning-message text-center mb-6">
            <h3 class="font-bold text-lg mb-2">
                <i class="fas fa-exclamation-circle mr-2"></i> Important Note on Mobile Overlay
            </h3>
            <p class="text-sm">
                The requested feature to scan your phone screen for Probo data and overlay predictions is **not technically possible** within a standard web application due to strict security and privacy policies of web browsers and mobile operating systems (iOS/Android).
            </p>
            <p class="text-sm mt-2">
                Websites are restricted from accessing content outside their own tab. Implementing such a feature would require developing a complex native mobile application with special OS permissions, which is beyond the scope of a web-based project. Please manually input the data from Probo into this tool.
            </p>
        </div>

        <!-- Cheat Sheet Reference -->
        <h2 class="text-2xl font-semibold mb-4 text-gold-100">
            <i class="fas fa-book-open text-gold-500 mr-2"></i> Crypto Probo Prediction Cheat Sheet Reference
        </h2>
        <p class="text-gold-400 mb-4">This section provides the original guidelines for reference, updated with new indicators.</p>

        <h3 class="text-xl font-semibold text-gold-100 mb-2">✅ TRUST the Prediction When:</h3>
        <ul class="list-disc list-inside text-gold-300 space-y-2 mb-4">
            <li><strong>Time to expiry is &lt; 2 hours</strong>: Short-term moves are easier to project with recent trend/sentiment.</li>
            <li><strong>[Currency] is trending cleanly (up or down)</strong>: EMA crossover + delta will align clearly; MACD bearish crossover is absent.</li>
            <li><strong>Sentiment score is strongly positive/negative (&gt;0.2)</strong>: Clear market direction from sentiment.</li>
            <li><strong>RSI is not extreme (30–70)</strong>: Means no strong mean-reversion counterforces.</li>
            <li><strong>No major news expected</strong>: Market moves more "technically" in news-free windows; sentiment score > 0.05.</li>
            <li><strong>Candle bodies are stable (not huge wicks)</strong>: Less noise = better delta prediction accuracy. Candle volatility is low.</li>
            <li><strong>MACD shows bullish crossover</strong>: Indicates strengthening upward momentum; MACD line > Signal line and Histogram > 0.</li>
            <li><strong>Stochastic is oversold (potential rebound)</strong>: Price may be due for an upward correction; %K &lt; 20, %D &lt; 20, and %K > %D.</li>
            <li><strong>Price near lower Bollinger Band (potential support)</strong>: Suggests price is at a strong support level.</li>
            <li><strong>No massive move recently</strong>: Predictable price action.</li>
            <li><strong>Bollinger Bands are stable (not squeezing/expanding)</strong>: Less volatility uncertainty.</li>
            <li><strong>No recent volume spike</strong>: Market not reacting to sudden news/events.</li>
        </ul>

        <h3 class="text-xl font-semibold text-gold-100 mb-2">⚠️ BE CAUTIOUS / DOUBLE-CHECK When:</h3>
        <ul class="list-disc list-inside text-gold-300 space-y-2 mb-4">
            <li><strong>Target time is &gt; 3 hours away</strong>: Market conditions may shift unpredictably.</li>
            <li><strong>[Currency] just made a massive move</strong>: Mean reversion likely → momentum may reverse.</li>
            <li><strong>RSI is &gt; 70 or &lt; 30 (extreme)</strong>: Overbought/oversold zones are prone to reversals.</li>
            <li><strong>Sentiment is conflicting (score ≈ 0)</strong>: Market indecisive — avoid betting.</li>
            <li><strong>Market Volatility due to News/Events (sentiment conflicting OR volume spike)</strong>: Trends and sentiment can break instantly due to external factors or sudden interest.</li>
            <li><strong>Candle volatility is high (huge wicks)</strong>: Delta estimates become noisy and inaccurate.</li>
            <li><strong>MACD shows bearish crossover</strong>: Indicates strengthening downward momentum; MACD line &lt; Signal line and Histogram &lt; 0.</li>
            <li><strong>Stochastic is overbought (potential reversal)</strong>: Price may be due for a downward correction; %K &gt; 80, %D &gt; 80, and %K &lt; %D.</li>
            <li><strong>Price near upper Bollinger Band or BB contracting</strong>: Suggests strong resistance or potential for volatile breakout.</li>
            <li><strong>Bollinger Bands are volatile (squeezing/expanding)</strong>: High uncertainty, potential for sharp moves.</li>
            <li><strong>Recent volume spike</strong>: Market reacting to sudden news/events, unpredictable.</li>
        </ul>

        <h3 class="text-xl font-semibold text-gold-100 mb-2">🔐 Pro Tip (Original Reference):</h3>
        <p class="text-gold-300 mb-2">If at least 7/12 “Trust” signals align AND less than 4 “Caution” flags are present → GO with the vote.</p>
        <p class="text-gold-300 mb-4">If 4+ “Caution” flags are present → SKIP the trade or wait.</p>

        <h3 class="text-xl font-semibold text-gold-100 mb-2">✅ Example: When to TRUST (Original Reference)</h3>
        <ul class="list-disc list-inside text-gold-300 space-y-1 mb-4">
            <li>Time: 1 hour left</li>
            <li>BTC uptrending (EMA20 &gt; EMA50, no bearish MACD cross)</li>
            <li>RSI = 58 (Neutral)</li>
            <li>Sentiment = +0.3 (Strong positive)</li>
            <li>MACD bullish crossover</li>
            <li>Stochastic not extreme (e.g., 40, 35)</li>
            <li>Price not near BB extremes (e.g., mid-band)</li>
            <li>No massive move recently</li>
            <li>BB stable</li>
            <li>No recent volume spike</li>
            <li>→ ✅ Trust YES vote</li>
        </ul>

        <h3 class="text-xl font-semibold text-gold-100 mb-2">⚠️ Example: When to AVOID (Original Reference)</h3>
        <ul class="list-disc list-inside text-gold-300 space-y-1 mb-4">
            <li>Time: 4 hours left</li>
            <li>BTC dumped $800 in 15 mins (Massive move)</li>
            <li>RSI = 22 (Oversold)</li>
            <li>Sentiment = 0.05 (Conflicting)</li>
            <li>MACD bearish crossover</li>
            <li>Stochastic overbought (e.g., 90, 85)</li>
            <li>Price near upper BB</li>
            <li>BB squeezing</li>
            <li>Recent volume spike</li>
            <li>→ ⚠️ Avoid vote — unpredictable zone</li>
        </ul>

    </div>

    <script>
        // Helper function to toggle expander sections
        function setupExpander(headerId, contentId) {
            const header = document.getElementById(headerId);
            const content = document.getElementById(contentId);
            const arrow = header ? header.querySelector('.arrow') : null;

            if (!header || !content || !arrow) { // Robustness check
                // console.warn(`Expander setup failed for ${headerId}. Element not found.`);
                return;
            }

            header.addEventListener('click', () => {
                const isExpanded = content.classList.contains('expanded');
                if (isExpanded) {
                    content.classList.remove('expanded');
                    arrow.classList.remove('expanded');
                } else {
                    content.classList.add('expanded');
                    arrow.classList.add('expanded');
                }
            });
        }

        // --- Backend API URL ---
        // const BACKEND_API_URL = 'http://localhost:5000'; // Use this for local development!
        const BACKEND_API_URL = 'https://html-probo-predictor-website.onrender.com'; // IMPORTANT: Change this for deployment!

        // Global data storage for both BTC and ETH
        let allMarketData = {
            BTC: { current_price: 0.0, sentiment_score: 0.0, market_conditions: {}, chart_data: [] },
            ETH: { current_price: 0.0, sentiment_score: 0.0, market_conditions: {}, chart_data: [] }
        };
        let selectedCurrency = 'BTC'; // Default selected currency

        // --- UI Update Functions ---

        function updateConfidenceSignal(elementId, isTrue) {
            const element = document.getElementById(elementId);
            const iconId = elementId + '-icon';
            const iconElement = document.getElementById(iconId);

            if (!element) return; // Guard against missing elements

            if (isTrue) {
                element.innerHTML = '<strong class="text-green-400">YES</strong>';
                if (iconElement) iconElement.innerHTML = '<i class="fas fa-check-circle check-icon mr-2"></i>';
            } else {
                element.innerHTML = '<strong class="text-red-400">NO</strong>';
                if (iconElement) iconElement.innerHTML = '<i class="fas fa-times-circle cross-icon mr-2"></i>';
            }
        }

        // Global variable to keep track of chart instances
        let plotlyChartInstance = null;

        function updateUI(currencyData, predictionResult = null, geminiAiResult = null) {
            const { current_price, sentiment_score, market_conditions, chart_data } = currencyData;

            // Update currency symbol display
            document.getElementById('current-currency-symbol').textContent = selectedCurrency;

            // Update Current Price Metric
            document.getElementById('current-price-display').textContent = `$${current_price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            // Update Technical Indicators
            document.getElementById('metric-rsi').textContent = market_conditions.rsi !== null ? market_conditions.rsi.toFixed(2) : 'N/A';
            document.getElementById('metric-ema20').textContent = market_conditions.ema_20 !== null ? market_conditions.ema_20.toFixed(2) : 'N/A';
            document.getElementById('metric-ema50').textContent = market_conditions.ema_50 !== null ? market_conditions.ema_50.toFixed(2) : 'N/A';
            document.getElementById('metric-macd').textContent = market_conditions.macd !== null ? market_conditions.macd.toFixed(2) : 'N/A';
            document.getElementById('metric-stochk').textContent = market_conditions.stoch_k !== null ? market_conditions.stoch_k.toFixed(2) : 'N/A';
            document.getElementById('metric-stochd').textContent = market_conditions.stoch_d !== null ? market_conditions.stoch_d.toFixed(2) : 'N/A';

            const bbUpper = market_conditions.bb_upper !== null ? market_conditions.bb_upper.toFixed(2) : 'N/A';
            const bbMid = market_conditions.bb_mid !== null ? market_conditions.bb_mid.toFixed(2) : 'N/A';
            const bbLower = market_conditions.bb_lower !== null ? market_conditions.bb_lower.toFixed(2) : 'N/A';
            document.getElementById('metric-bb').textContent = `${bbUpper} / ${bbMid} / ${bbLower}`;
            document.getElementById('metric-bb-width').textContent = market_conditions.bb_width !== null ? market_conditions.bb_width.toFixed(2) : 'N/A';


            document.getElementById('market-trend').textContent = market_conditions.bullish_trend ? '📈 Uptrend (EMA20 > EMA50)' : '📉 Downtrend (EMA20 < EMA50)';
            let rsiZone = '';
            if (market_conditions.overbought) rsiZone = '🔥 Overbought (>70)';
            else if (market_conditions.oversold) rsiZone = '🧊 Oversold (<30)';
            else rsiZone = '✅ Neutral (30-70)';
            document.getElementById('market-rsi-zone').textContent = rsiZone;

            let stochZone = '';
            if (market_conditions.stoch_overbought) stochZone = '🔥 Overbought (>80)';
            else if (market_conditions.stoch_oversold) stochZone = '🧊 Oversold (<20)';
            else stochZone = '✅ Neutral (20-80)';
            document.getElementById('market-stoch-zone').textContent = stochZone;

            // Update Chart
            drawChart(chart_data);

            // Update Prophet Prediction Summary and Confidence Advisor if predictionResult is available
            if (predictionResult) {
                document.getElementById('summary-current-price').textContent = `$${predictionResult.current_price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('summary-avg-delta').textContent = `$${predictionResult.avg_delta_per_hour.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('summary-time-left').textContent = `${predictionResult.hours_remaining} hr(s)`;
                document.getElementById('summary-projected-price').textContent = `$${predictionResult.projected_price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('summary-sentiment-score').textContent = predictionResult.sentiment.toFixed(2);
                document.getElementById('summary-target-time').textContent = predictionResult.target_time_ist; // Use IST string here

                const voteMessageDiv = document.getElementById('recommended-vote-message');
                if (predictionResult.vote === "YES") {
                    voteMessageDiv.className = 'success-message text-center text-xl font-bold py-3 px-4 rounded-lg';
                    voteMessageDiv.innerHTML = `🧠 Prophet Recommended Vote: <strong class="text-green-400">YES</strong>`;
                } else {
                    voteMessageDiv.className = 'warning-message text-center text-xl font-bold py-3 px-4 rounded-lg';
                    voteMessageDiv.innerHTML = `🧠 Prophet Recommended Vote: <strong class="text-red-400">NO</strong>`;
                }
                voteMessageDiv.classList.remove('hidden');

                const confidence = predictionResult.confidence_advisor;

                // Update Trust Signals
                document.getElementById('trust-currency-name').textContent = selectedCurrency;
                updateConfidenceSignal('trust-time', confidence.trust_conditions.time_expiry_lt_2hr);
                updateConfidenceSignal('trust-trend', confidence.trust_conditions.trending_cleanly);
                updateConfidenceSignal('trust-sentiment', confidence.trust_conditions.sentiment_strong);
                document.getElementById('trust-sentiment').innerHTML += ` (Score: ${sentiment_score.toFixed(2)})`; // Add score for context
                updateConfidenceSignal('trust-rsi', confidence.trust_conditions.rsi_neutral);
                document.getElementById('trust-rsi').innerHTML += ` (RSI: ${market_conditions.rsi !== null ? market_conditions.rsi.toFixed(2) : 'N/A'})`; // Add RSI for context
                updateConfidenceSignal('trust-news', confidence.trust_conditions.no_major_news_expected);
                updateConfidenceSignal('trust-stable-candles', confidence.trust_conditions.candle_bodies_stable_not_volatile);
                updateConfidenceSignal('trust-macd-bullish', confidence.trust_conditions.macd_bullish_crossover_confirmed);
                updateConfidenceSignal('trust-stoch-oversold', confidence.trust_conditions.stoch_oversold_bullish_cross);
                updateConfidenceSignal('trust-bb-lower', confidence.trust_conditions.price_near_bb_lower);
                updateConfidenceSignal('trust-no-massive-move', confidence.trust_conditions.no_massive_move_recent);
                updateConfidenceSignal('trust-bb-stable', confidence.trust_conditions.bb_stable);
                updateConfidenceSignal('trust-no-volume-spike', confidence.trust_conditions.no_volume_spike_recent);


                // Update Caution Flags
                document.getElementById('caution-currency-name').textContent = selectedCurrency;
                updateConfidenceSignal('caution-time', confidence.caution_conditions.target_time_gt_3hr);
                updateConfidenceSignal('caution-massive-move', confidence.caution_conditions.btc_massive_move);
                updateConfidenceSignal('caution-rsi', confidence.caution_conditions.rsi_extreme);
                document.getElementById('caution-rsi').innerHTML += ` (RSI: ${market_conditions.rsi !== null ? market_conditions.rsi.toFixed(2) : 'N/A'})`; // Add RSI for context
                updateConfidenceSignal('caution-sentiment', confidence.caution_conditions.sentiment_conflicting);
                document.getElementById('caution-sentiment').innerHTML += ` (Score: ${sentiment_score.toFixed(2)})`; // Add score for context
                updateConfidenceSignal('caution-big-news', confidence.caution_conditions.big_news_coming_or_volume_spike);
                updateConfidenceSignal('caution-volatile-candles', confidence.caution_conditions.candle_volatility_high);
                updateConfidenceSignal('caution-macd-bearish', confidence.caution_conditions.macd_bearish_crossover_confirmed);
                updateConfidenceSignal('caution-stoch-overbought', confidence.caution_conditions.stoch_overbought_bearish_cross);
                updateConfidenceSignal('caution-bb-upper-contracting', confidence.caution_conditions.price_near_bb_upper_or_bb_volatile); // Adjusted to match backend key
                updateConfidenceSignal('caution-bb-volatile', confidence.caution_conditions.bb_volatile);
                updateConfidenceSignal('caution-volume-spike', confidence.caution_conditions.volume_spike_recent);


                document.getElementById('total-trust-signals').textContent = confidence.trust_signals_count;
                document.getElementById('total-caution-flags').textContent = confidence.caution_flags_count;

                const proTipMessageDiv = document.getElementById('pro-tip-message');
                let proTipClass = '';
                let adviceMessage = confidence.advice_message;

                if (confidence.trust_signals_count >= 7 && confidence.caution_flags_count < 4) {
                    proTipClass = 'success-message';
                } else if (confidence.caution_flags_count >= 4) {
                    proTipClass = 'warning-message';
                } else {
                    proTipClass = 'info-message';
                }
                proTipMessageDiv.innerHTML = `<div class="${proTipClass}"><strong class="text-lg">${adviceMessage}</strong><p class="text-sm mt-1">Trust: ${confidence.trust_signals_count}/12, Caution: ${confidence.caution_flags_count}/11</p></div>`;
            } else {
                // Clear prediction results if no prediction is active
                document.getElementById('recommended-vote-message').classList.add('hidden');
                document.getElementById('pro-tip-message').innerHTML = '';

                // Reset confidence advisor status to N/A
                const trustElements = [
                    'trust-time', 'trust-trend', 'trust-sentiment', 'trust-rsi', 'trust-news',
                    'trust-stable-candles', 'trust-macd-bullish', 'trust-stoch-oversold',
                    'trust-bb-lower', 'trust-no-massive-move', 'trust-bb-stable', 'trust-no-volume-spike'
                ];
                const cautionElements = [
                    'caution-time', 'caution-massive-move', 'caution-rsi', 'caution-sentiment',
                    'caution-big-news', 'caution-volatile-candles', 'caution-macd-bearish',
                    'caution-stoch-overbought', 'caution-bb-upper-contracting',
                    'caution-bb-volatile', 'caution-volume-spike'
                ];

                trustElements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = 'N/A';
                    const iconElement = document.getElementById(id + '-icon');
                    if (iconElement) iconElement.innerHTML = '<i class="fas fa-question-circle text-gray-500 mr-2"></i>';
                });
                cautionElements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = 'N/A';
                    const iconElement = document.getElementById(id + '-icon');
                    if (iconElement) iconElement.innerHTML = '<i class="fas fa-question-circle text-gray-500 mr-2"></i>';
                });

                document.getElementById('total-trust-signals').textContent = '0';
                document.getElementById('total-caution-flags').textContent = '0';

                document.getElementById('trust-currency-name').textContent = selectedCurrency;
                document.getElementById('caution-currency-name').textContent = selectedCurrency;
            }

            // Update Gemini AI Vote Section
            const geminiAiVoteElem = document.getElementById('gemini-ai-vote');
            const geminiAiReasoningElem = document.getElementById('gemini-ai-reasoning');
            if (geminiAiResult) {
                if (geminiAiResult.ai_vote === "YES") {
                    geminiAiVoteElem.innerHTML = `<strong class="text-green-400">YES</strong>`;
                } else if (geminiAiResult.ai_vote === "NO") {
                    geminiAiVoteElem.innerHTML = `<strong class="text-red-400">NO</strong>`;
                } else {
                    geminiAiVoteElem.innerHTML = `<strong class="text-gray-400">N/A</strong>`;
                }
                geminiAiReasoningElem.textContent = geminiAiResult.ai_reasoning;
            } else {
                geminiAiVoteElem.innerHTML = `<strong class="text-gray-400">N/A</strong>`;
                geminiAiReasoningElem.textContent = 'Awaiting prediction...';
            }
        }

        // --- Charting with Plotly.js ---

        function drawChart(chartData) {
            if (!Array.isArray(chartData) || chartData.length === 0) {
                console.warn("No chart data available to draw.");
                Plotly.purge('candlestick-chart');
                plotlyChartInstance = null; // Clear instance if no data
                return;
            }

            const timestamps = chartData.map(d => d.timestamp);
            const openPrices = chartData.map(d => d.open);
            const highPrices = chartData.map(d => d.high);
            const lowPrices = chartData.map(d => d.low);
            const closePrices = chartData.map(d => d.close);
            const volume = chartData.map(d => d.volume);
            const ema20 = chartData.map(d => d.EMA_20);
            const ema50 = chartData.map(d => d.EMA_50);
            const bbUpper = chartData.map(d => d.BB_Upper);
            const bbLower = chartData.map(d => d.BB_Lower);
            const bbMid = chartData.map(d => d.BB_Mid);
            const macd = chartData.map(d => d.MACD);
            const macdSignal = chartData.map(d => d.MACD_Signal);
            const macdHist = chartData.map(d => d.MACD_Hist);
            const stochK = chartData.map(d => d.STOCH_K);
            const stochD = chartData.map(d => d.STOCH_D);

            // Define traces
            const traces = [];

            // Candlestick trace (main price chart)
            traces.push({
                x: timestamps,
                open: openPrices,
                high: highPrices,
                low: lowPrices,
                close: closePrices,
                type: 'candlestick',
                name: 'Candles',
                increasing: { line: { color: '#FFD700' } }, /* Gold for increasing */
                decreasing: { line: { color: '#B22222' } }, /* Firebrick for decreasing */
                xaxis: 'x',
                yaxis: 'y'
            });

            // EMA 20
            traces.push({
                x: timestamps,
                y: ema20,
                type: 'scatter',
                mode: 'lines',
                name: 'EMA 20',
                line: { color: '#87CEEB', width: 1.5 }, /* SkyBlue */
                showlegend: true,
                xaxis: 'x',
                yaxis: 'y'
            });

            // EMA 50
            traces.push({
                x: timestamps,
                y: ema50,
                type: 'scatter',
                mode: 'lines',
                name: 'EMA 50',
                line: { color: '#DAA520', width: 1.5 }, /* Goldenrod */
                showlegend: true,
                xaxis: 'x',
                yaxis: 'y'
            });

            // BB Mid
            traces.push({
                x: timestamps,
                y: bbMid,
                type: 'scatter',
                mode: 'lines',
                name: 'BB Mid',
                line: { color: '#A9A9A9', width: 1, dash: 'dash' }, /* DarkGrey */
                showlegend: true,
                xaxis: 'x',
                yaxis: 'y'
            });
            // BB Upper
            traces.push({
                x: timestamps,
                y: bbUpper,
                type: 'scatter',
                mode: 'lines',
                name: 'BB Upper',
                line: { color: '#6A5ACD', width: 1 }, /* SlateBlue */
                showlegend: true,
                xaxis: 'x',
                yaxis: 'y'
            });
            // BB Lower
            traces.push({
                x: timestamps,
                y: bbLower,
                type: 'scatter',
                mode: 'lines',
                name: 'BB Lower',
                line: { color: '#6A5ACD', width: 1 }, /* SlateBlue */
                showlegend: true,
                xaxis: 'x',
                yaxis: 'y'
            });

            // Volume
            traces.push({
                x: timestamps,
                y: volume,
                type: 'bar',
                name: 'Volume',
                marker: { color: '#444444' }, /* Darker grey for volume bars */
                showlegend: false,
                xaxis: 'x2',
                yaxis: 'y2'
            });

            // MACD Line
            traces.push({
                x: timestamps,
                y: macd,
                type: 'scatter',
                mode: 'lines',
                name: 'MACD',
                line: { color: '#FFD700', width: 1.5 }, /* Gold */
                showlegend: true,
                xaxis: 'x3',
                yaxis: 'y3'
            });

            // MACD Signal Line
            traces.push({
                x: timestamps,
                y: macdSignal,
                type: 'scatter',
                mode: 'lines',
                name: 'Signal',
                line: { color: '#87CEEB', width: 1.5, dash: 'dot' }, /* SkyBlue */
                showlegend: true,
                xaxis: 'x3',
                yaxis: 'y3'
            });

            // MACD Histogram
            traces.push({
                x: timestamps,
                y: macdHist,
                type: 'bar',
                name: 'Histogram',
                marker: {
                    color: macdHist.map(val => val >= 0 ? '#9ae6b4' : '#feb2b2') /* Green for positive, Red for negative */
                },
                showlegend: false,
                xaxis: 'x3',
                yaxis: 'y3'
            });

            // Stochastic %K
            traces.push({
                x: timestamps,
                y: stochK,
                type: 'scatter',
                mode: 'lines',
                name: '%K',
                line: { color: '#FFD700', width: 1.5 }, /* Gold */
                showlegend: true,
                xaxis: 'x4',
                yaxis: 'y4'
            });

            // Stochastic %D
            traces.push({
                x: timestamps,
                y: stochD,
                type: 'scatter',
                mode: 'lines',
                name: '%D',
                line: { color: '#87CEEB', width: 1.5, dash: 'dot' }, /* SkyBlue */
                showlegend: true,
                xaxis: 'x4',
                yaxis: 'y4'
            });

            // Define layout with multiple axes
            const layout = {
                grid: {
                    rows: 4,
                    columns: 1,
                    pattern: 'independent',
                    rowheights: [0.5, 0.2, 0.15, 0.15],
                    subplots: [['xy'], ['xy2'], ['xy3'], ['xy4']] // Map traces to subplots
                },
                xaxis: {
                    rangeslider: { visible: false },
                    type: 'date',
                    title: 'Time',
                    tickfont: { color: '#DAA520' },
                    gridcolor: '#333333',
                    linecolor: '#444444'
                },
                xaxis2: {
                    rangeslider: { visible: false },
                    type: 'date',
                    tickfont: { color: '#DAA520' },
                    gridcolor: '#333333',
                    linecolor: '#444444'
                },
                xaxis3: {
                    rangeslider: { visible: false },
                    type: 'date',
                    tickfont: { color: '#DAA520' },
                    gridcolor: '#333333',
                    linecolor: '#444444'
                },
                xaxis4: {
                    rangeslider: { visible: false },
                    type: 'date',
                    tickfont: { color: '#DAA520' },
                    gridcolor: '#333333',
                    linecolor: '#444444',
                    range: [0, 100] /* Stochastic is always 0-100 */
                },
                yaxis: {
                    title: 'Price (USDT)',
                    tickfont: { color: '#DAA520' },
                    gridcolor: '#333333',
                    linecolor: '#444444'
                },
                yaxis2: {
                    title: 'Volume',
                    tickfont: { color: '#DAA520' },
                    gridcolor: '#333333',
                    linecolor: '#444444'
                },
                yaxis3: {
                    title: 'MACD',
                    tickfont: { color: '#DAA520' },
                    gridcolor: '#333333',
                    linecolor: '#444444'
                },
                yaxis4: {
                    title: 'Stochastic',
                    tickfont: { color: '#DAA520' },
                    gridcolor: '#333333',
                    linecolor: '#444444',
                    range: [0, 100] /* Stochastic is always 0-100 */
                },
                plot_bgcolor: '#222222',
                paper_bgcolor: '#222222',
                font: { color: '#FFD700' },
                margin: { l: 40, r: 40, t: 30, b: 30 },
                showlegend: true,
                legend: {
                    x: 0, y: 1.15,
                    bgcolor: 'rgba(0,0,0,0)',
                    bordercolor: 'rgba(0,0,0,0)',
                    font: { color: '#FFD700' }
                }
            };

            if (plotlyChartInstance) {
                // If chart exists, update it with new data
                Plotly.react('candlestick-chart', traces, layout, { responsive: true, displayModeBar: true });
            } else {
                // Otherwise, create a new chart
                Plotly.newPlot('candlestick-chart', traces, layout, { responsive: true, displayModeBar: true })
                    .then(gd => {
                        plotlyChartInstance = gd; // Store the chart instance
                    })
                    .catch(error => {
                        console.error("Error creating Plotly chart:", error);
                        Plotly.purge('candlestick-chart');
                        plotlyChartInstance = null;
                        document.getElementById('candlestick-chart').innerHTML = '<div class="error-message text-center p-4">❌ Failed to load chart. Check console for details.</div>';
                    });
            }
        }

        // --- Main Application Logic ---

        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.classList.remove('hidden');
        }

        function hideLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.classList.add('hidden');
        }

        function updateCurrentISTTime() {
            const now = new Date();
            const options = {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false,
                timeZone: 'Asia/Kolkata'
            };
            const timeElement = document.getElementById('current-ist-time');
            if (timeElement) timeElement.textContent = now.toLocaleTimeString('en-IN', options);
        }

        async function initializeApp() {
            showLoading('loading-spinner');
            const priceDisplay = document.getElementById('current-price-display');
            if (priceDisplay) priceDisplay.textContent = "Loading...";

            const messageDiv = document.getElementById('recommended-vote-message');
            if (messageDiv) {
                messageDiv.innerHTML = '';
                messageDiv.classList.add('hidden');
            }
            const proTipMessage = document.getElementById('pro-tip-message');
            if (proTipMessage) proTipMessage.innerHTML = '';

            try {
                const response = await fetch(`${BACKEND_API_URL}/api/market_data`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.error || response.statusText}`);
                }
                allMarketData = await response.json();

                // Update UI with data for the currently selected currency, clear previous predictions
                updateUI(allMarketData[selectedCurrency], null, null);

            } catch (error) {
                console.error("Error fetching market data:", error);
                const messageDiv = document.getElementById('recommended-vote-message');
                if (messageDiv) {
                    messageDiv.innerHTML = `<div class="error-message">❌ Failed to load market data. Please ensure the backend server is running and accessible at ${BACKEND_API_URL}. Error: ${error.message}</div>`;
                    messageDiv.classList.remove('hidden');
                }
                if (priceDisplay) priceDisplay.textContent = "$ERROR";
            } finally {
                hideLoading('loading-spinner');
            }
        }

        // Handle form submission
        document.getElementById('prediction-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            showLoading('prediction-spinner');
            showLoading('gemini-vote-spinner');
            const geminiAiVoteElem = document.getElementById('gemini-ai-vote');
            const geminiAiReasoningElem = document.getElementById('gemini-ai-reasoning');
            if(geminiAiVoteElem) geminiAiVoteElem.innerHTML = 'Loading...';
            if(geminiAiReasoningElem) geminiAiReasoningElem.textContent = 'Generating AI analysis...';

            const targetPrice = parseFloat(document.getElementById('target-price').value);
            const targetTimeStr = document.getElementById('target-time').value;
            const selectedCurrencyForPrediction = document.querySelector('input[name="currency"]:checked').value;

            const messageDiv = document.getElementById('recommended-vote-message');
            if (messageDiv) {
                messageDiv.innerHTML = '';
                messageDiv.classList.add('hidden');
            }
            const proTipMessage = document.getElementById('pro-tip-message');
            if (proTipMessage) proTipMessage.innerHTML = '';


            if (isNaN(targetPrice) || !targetTimeStr) {
                if (messageDiv) {
                    messageDiv.innerHTML = `<div class="error-message">❌ Please enter a valid target price and time.</div>`;
                    messageDiv.classList.remove('hidden');
                }
                hideLoading('prediction-spinner');
                hideLoading('gemini-vote-spinner');
                if(geminiAiVoteElem) geminiAiVoteElem.innerHTML = 'N/A';
                if(geminiAiReasoningElem) geminiAiReasoningElem.textContent = 'Invalid input for prediction.';
                return;
            }

            let prophetPredictionResult = null;
            let geminiAiPredictionResult = null;

            try {
                // 1. Get Prophet Prediction
                const prophetResponse = await fetch(`${BACKEND_API_URL}/api/predict`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_price: targetPrice,
                        target_time: targetTimeStr,
                        currency: selectedCurrencyForPrediction
                    })
                });

                if (!prophetResponse.ok) {
                    const errorData = await prophetResponse.json();
                    throw new Error(`Prophet prediction failed: ${errorData.error || prophetResponse.statusText}`);
                }
                prophetPredictionResult = await prophetResponse.json();

                // 2. Get Gemini AI Prediction
                const geminiAiResponse = await fetch(`${BACKEND_API_URL}/api/gemini_ai_vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_price: targetPrice,
                        target_time: targetTimeStr,
                        currency: selectedCurrencyForPrediction
                    })
                });

                if (!geminiAiResponse.ok) {
                    const errorData = await geminiAiResponse.json();
                    throw new Error(`Gemini AI prediction failed: ${errorData.error || geminiAiResponse.statusText}`);
                }
                geminiAiPredictionResult = await geminiAiResponse.json();


                // 3. Re-fetch all market data to ensure the UI is consistent with the latest backend state
                const marketDataResponse = await fetch(`${BACKEND_API_URL}/api/market_data`);
                if (!marketDataResponse.ok) {
                    const errorData = await marketDataResponse.json();
                    throw new Error(`Failed to refresh market data after prediction: ${errorData.error || marketDataResponse.statusText}`);
                }
                allMarketData = await marketDataResponse.json();

                // Update UI with both prediction results for the *selected* currency
                updateUI(allMarketData[selectedCurrency], prophetPredictionResult, geminiAiPredictionResult);

            } catch (error) {
                console.error("Error during prediction:", error);
                if (messageDiv) {
                    messageDiv.innerHTML = `<div class="error-message">❌ ${error.message}</div>`;
                    messageDiv.classList.remove('hidden');
                }
                if(geminiAiVoteElem) geminiAiVoteElem.innerHTML = 'ERROR';
                if(geminiAiReasoningElem) geminiAiReasoningElem.textContent = `Failed to get AI prediction: ${error.message}`;
            } finally {
                hideLoading('prediction-spinner');
                hideLoading('gemini-vote-spinner');
            }
        });

        // Handle currency selection change
        document.querySelectorAll('input[name="currency"]').forEach(radio => {
            radio.addEventListener('change', (event) => {
                selectedCurrency = event.target.value;
                // Update UI immediately with the newly selected currency's data, clearing old prediction results
                updateUI(allMarketData[selectedCurrency], null, null);
            });
        });

        // --- Chart resize on expand handler (NEW) ---
        function setupExpanderWithPlotly(headerId, contentId, plotlyDivId) {
            const header = document.getElementById(headerId);
            const content = document.getElementById(contentId);
            const arrow = header ? header.querySelector('.arrow') : null;

            if (!header || !content || !arrow) return;

            header.addEventListener('click', () => {
                content.classList.toggle('expanded');
                arrow.classList.toggle('expanded');
                // If content is now expanded, trigger Plotly resize
                if (content.classList.contains('expanded') && plotlyChartInstance && plotlyDivId) {
                    setTimeout(() => Plotly.relayout(plotlyDivId, {autosize: true}), 500); // Allow animation to finish
                }
            });
        }

        // --- Chatbot Logic ---
        const chatWindow = document.getElementById('chat-window'); // This is inside the potentially floating div
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const chatSpinner = document.getElementById('chat-spinner');
        const chatFileInput = document.getElementById('chat-file-input');
        const uploadedFilesPreview = document.getElementById('uploaded-files-preview');
        const chatErrorMessage = document.getElementById('chat-error-message');

        let attachedFiles = [];

        function addMessageToChat(sender, message, files = []) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', sender);

            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble', sender);
            bubble.textContent = message;
            messageDiv.appendChild(bubble);

            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.classList.add('chat-file-preview');
                    messageDiv.appendChild(img);
                } else {
                    const fileText = document.createElement('p');
                    fileText.classList.add('text-sm', 'text-gray-400', 'mt-1');
                    fileText.textContent = `Attached: ${file.name}`;
                    messageDiv.appendChild(fileText);
                }
            });

            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll to bottom
        }

        async function sendChatMessage() {
            const message = chatInput.value.trim();
            chatErrorMessage.classList.add('hidden');

            if (!message && attachedFiles.length === 0) {
                chatErrorMessage.textContent = 'Please enter a message or select a file.';
                chatErrorMessage.classList.remove('hidden');
                return;
            }

            addMessageToChat('user', message, attachedFiles);
            chatInput.value = ''; // Clear input
            uploadedFilesPreview.innerHTML = ''; // Clear file previews

            showLoading('chat-spinner');

            try {
                const formData = new FormData();
                if (message) {
                    formData.append('message', message);
                }
                attachedFiles.forEach((file) => {
                    formData.append('files', file);
                });

                const response = await fetch(`${BACKEND_API_URL}/api/ai_chat`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Chatbot error: ${errorData.error || response.statusText}`);
                }

                const result = await response.json();
                addMessageToChat('ai', result.ai_response);

            } catch (error) {
                console.error("Error sending chat message:", error);
                chatErrorMessage.textContent = `❌ ${error.message}`;
                chatErrorMessage.classList.remove('hidden');
                addMessageToChat('ai', `Sorry, I encountered an error: ${error.message}`);
            } finally {
                hideLoading('chat-spinner');
                attachedFiles = []; // Reset attached files after sending
                chatFileInput.value = ''; // Clear file input element itself
            }
        }

        sendChatBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent new line in textarea
                sendChatMessage();
            }
        });

        chatFileInput.addEventListener('change', (event) => {
            uploadedFilesPreview.innerHTML = ''; // Clear previous previews
            attachedFiles = Array.from(event.target.files);

            attachedFiles.forEach((file, index) => {
                const listItem = document.createElement('li');
                listItem.classList.add('flex', 'justify-between', 'items-center', 'text-gold-300');
                listItem.innerHTML = `
                    <span><i class="fas fa-file mr-2"></i>${file.name}</span>
                    <i class="fas fa-times-circle remove-file cursor-pointer" data-index="${index}"></i>
                `;
                uploadedFilesPreview.appendChild(listItem);
            });

            // Add event listeners for removing files
            uploadedFilesPreview.querySelectorAll('.remove-file').forEach(button => {
                button.addEventListener('click', (e) => {
                    const indexToRemove = parseInt(e.target.dataset.index);
                    attachedFiles.splice(indexToRemove, 1); // Remove from array
                    e.target.closest('li').remove(); // Remove from UI
                    // If no files are left, clear the actual file input element
                    if (attachedFiles.length === 0) {
                        chatFileInput.value = '';
                    } else {
                        // Re-render the list to update indices
                        const tempFiles = Array.from(attachedFiles); // Copy to re-render
                        attachedFiles = []; // Clear for re-population
                        chatFileInput.files = null; // Clear native input
                        // Manually trigger the change event with new files (tricky for FileList)
                        // A simpler approach is just to update the preview list.
                        const dataTransfer = new DataTransfer();
                        tempFiles.forEach(file => dataTransfer.items.add(file));
                        chatFileInput.files = dataTransfer.files;
                        chatFileInput.dispatchEvent(new Event('change')); // Trigger re-render of preview
                    }
                });
            });
        });


        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            updateCurrentISTTime(); // Set initial time
            setInterval(updateCurrentISTTime, 1000); // Update time every second

            // Setup all expanders. Chart expander now explicitly handles Plotly resize.
            setupExpander('prediction-summary-expander', 'prediction-summary-content');
            setupExpander('technical-indicators-expander', 'technical-indicators-content');
            setupExpanderWithPlotly('chart-expander', 'chart-content', 'candlestick-chart'); // Specific setup for chart
            setupExpander('trust-signals-expander', 'trust-signals-content');
            setupExpander('caution-flags-expander', 'caution-flags-content');
            setupExpander('gemini-ai-vote-expander', 'gemini-ai-vote-content');

            // Initialize chart on page load (it's expanded by default now)
            // This call will be redundant after initialApp() is done, but safe.
            // The actual data will be loaded by initializeApp.
            // drawChart(allMarketData[selectedCurrency].chart_data); // Removed - initializeApp handles this now.
        });

        // Periodically update market data (e.g., every 1 minute for a more "real-time" feel)
        setInterval(initializeApp, 60000); // 60000 ms = 1 minute

        // --- Floating Chatbot UI/Logic (NEW) ---
        const floatingChatbotContainer = document.createElement('div');
        floatingChatbotContainer.id = 'floating-chatbot-container';
        floatingChatbotContainer.className = 'fixed bottom-4 right-4 z-50 flex flex-col items-end';
        document.body.appendChild(floatingChatbotContainer);

        const chatToggleBtn = document.createElement('button');
        chatToggleBtn.id = 'chat-toggle-btn';
        chatToggleBtn.innerHTML = '<i class="fas fa-comment"></i>'; // Initial icon
        floatingChatbotContainer.appendChild(chatToggleBtn);

        // Get the static chatbot section, then move its content
        const staticChatbotSection = document.getElementById('static-ai-chatbot-section');
        const chatbotContentMoved = staticChatbotSection.querySelector('#ai-chatbot-content');
        const chatbotHeaderMoved = staticChatbotSection.querySelector('#ai-chatbot-expander');

        // Hide the original static chatbot section from the main document flow
        staticChatbotSection.style.display = 'none';

        // Create a new container for the actual chatbot window that will be toggled
        const floatingChatWindow = document.createElement('div');
        floatingChatWindow.id = 'floating-chat-window-content';
        floatingChatWindow.className = 'w-96 bg-gray-900 rounded-lg shadow-xl overflow-hidden transform scale-0 origin-bottom-right transition-all duration-300 ease-in-out hidden'; // Initially hidden and scaled down

        floatingChatWindow.appendChild(chatbotHeaderMoved); // Move header to floating
        floatingChatWindow.appendChild(chatbotContentMoved); // Move content to floating
        floatingChatbotContainer.appendChild(floatingChatWindow);

        let isChatOpen = false;

        chatToggleBtn.addEventListener('click', () => {
            isChatOpen = !isChatOpen;
            if (isChatOpen) {
                floatingChatWindow.classList.remove('hidden');
                floatingChatWindow.classList.remove('scale-0');
                floatingChatWindow.classList.add('scale-100');
                chatToggleBtn.innerHTML = '<i class="fas fa-times"></i>'; // Change icon to 'X'
                // Expand the content inside the floating window if it's not already
                if (!chatbotContentMoved.classList.contains('expanded')) {
                    chatbotContentMoved.classList.add('expanded');
                    chatbotHeaderMoved.querySelector('.arrow').classList.add('expanded');
                }
                if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to bottom on open
            } else {
                floatingChatWindow.classList.remove('scale-100');
                floatingChatWindow.classList.add('scale-0');
                // Use a transitionend event to hide the element completely after the animation
                floatingChatWindow.addEventListener('transitionend', function handler() {
                    if (!isChatOpen) { // Only hide after transition if still closed
                        floatingChatWindow.classList.add('hidden');
                    }
                    floatingChatWindow.removeEventListener('transitionend', handler);
                });
                chatToggleBtn.innerHTML = '<i class="fas fa-comment"></i>'; // Change icon back to comment
            }
        });

        // Re-setup the chatbot content as an expander *within* the floating window
        // but ensure it's initially expanded when the floating window is shown.
        document.addEventListener('DOMContentLoaded', () => {
            const floatingChatbotContent = document.getElementById('ai-chatbot-content');
            const floatingChatbotHeader = document.getElementById('ai-chatbot-expander');
            const floatingChatbotArrow = floatingChatbotHeader ? floatingChatbotHeader.querySelector('.arrow') : null;

            if (floatingChatbotContent && floatingChatbotHeader && floatingChatbotArrow) {
                // The floating window itself will control visibility, so we ensure the internal content is always expanded
                floatingChatbotContent.classList.add('expanded');
                floatingChatbotArrow.classList.add('expanded'); // Make arrow point up by default for the internal content

                // Keep the internal expander functionality, but it will control internal scroll height, not main window visibility.
                floatingChatbotHeader.addEventListener('click', () => {
                    floatingChatbotContent.classList.toggle('expanded');
                    floatingChatbotArrow.classList.toggle('expanded');
                    if (floatingChatbotContent.classList.contains('expanded') && chatWindow) {
                        chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to bottom when content expands
                    }
                });
            }
        });
    </script>
</body>
</html>